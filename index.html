<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>App Visitas · Local + Mapa (1 archivo)</title>

  <!-- Leaflet (CDN) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:rgba(15,23,42,.10);
      --shadow:0 18px 45px rgba(2,6,23,.12);
      --radius:18px;
      --btn:#0f172a;
      --btnText:#fff;
      --chip:#eef2ff;
      --chipText:#3730a3;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 700px at 20% -10%, #e9efff 0%, transparent 55%),
                  radial-gradient(900px 600px at 100% 10%, #eafff4 0%, transparent 50%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:16px 14px 28px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      position:sticky;top:0;z-index:50;padding:10px 0 12px;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:34px;height:34px;border-radius:12px;
      background: linear-gradient(135deg,#111827,#334155);
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
    }
    h1{font-size:15px;margin:0;letter-spacing:.2px}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      border:1px solid var(--line);
      background:rgba(255,255,255,.7);
      padding:10px 12px;border-radius:999px;
      font-weight:800;font-size:12px;
      cursor:pointer;
    }
    .tab.active{
      background:var(--btn);color:var(--btnText);
      border-color:transparent;
      box-shadow: 0 12px 28px rgba(2,6,23,.18);
    }
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 920px){
      .grid{grid-template-columns: 1fr}
    }
    .card{
      background:rgba(255,255,255,.9);
      border:1px solid rgba(255,255,255,.35);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .card .hd .title{font-size:13px;font-weight:900}
    .badge{
      font-size:11px;font-weight:900;
      padding:7px 10px;border-radius:999px;
      background:rgba(15,23,42,.06);
      border:1px solid rgba(15,23,42,.10);
      color:var(--text);
      display:flex;align-items:center;gap:8px;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:#22c55e;box-shadow:0 0 0 4px rgba(34,197,94,.18)}
    .bd{padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .field{flex:1;min-width:150px}
    .field label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.12);
      background:rgba(255,255,255,.92);
      outline:none;
      font-size:14px;
    }
    textarea{min-height:88px;resize:vertical}
    .btnbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{
      border:1px solid rgba(15,23,42,.12);
      background:rgba(255,255,255,.92);
      color:var(--text);
      padding:12px 14px;border-radius:14px;
      font-weight:900;cursor:pointer;
    }
    .btn.primary{
      background:var(--btn);
      color:var(--btnText);
      border-color:transparent;
    }
    .btn.danger{
      background:#ef4444;color:#fff;border-color:transparent;
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .kpis{display:grid;grid-template-columns: repeat(3,1fr);gap:10px}
    @media (max-width:520px){ .kpis{grid-template-columns: 1fr} }
    .kpi{
      border:1px solid var(--line);
      background:rgba(255,255,255,.8);
      border-radius:16px;
      padding:12px;
    }
    .kpi .lbl{font-size:12px;color:var(--muted);display:flex;justify-content:space-between;gap:10px}
    .kpi .val{font-size:22px;font-weight:950;margin-top:6px}
    #mapCity, #mapAdmin{height:340px;border-radius:16px;border:1px solid var(--line);overflow:hidden}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .item{
      border:1px solid var(--line);
      background:rgba(255,255,255,.85);
      border-radius:16px;
      padding:12px;
    }
    .item .top{
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
      align-items:flex-start;
    }
    .item .name{font-weight:950}
    .item .meta{font-size:12px;color:var(--muted)}
    .chip{
      display:inline-flex;align-items:center;gap:6px;
      background:var(--chip);color:var(--chipText);
      border:1px solid rgba(55,48,163,.18);
      padding:6px 10px;border-radius:999px;
      font-weight:900;font-size:11px;
      white-space:nowrap;
    }
    .muted{color:var(--muted)}
    .hr{height:1px;background:var(--line);margin:14px 0}
    .small{font-size:12px}
    .hint{
      font-size:12px;color:var(--muted);
      line-height:1.35;
    }
    .footer{
      margin-top:14px;
      font-size:11px;color:var(--muted);
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>App Visitas · Local + Mapa</h1>
          <div class="sub">1 solo archivo (index.html) · Funciona en GitHub Pages · Sin Supabase</div>
        </div>
      </div>
      <div class="tabs" role="tablist">
        <button class="tab active" id="tabCity" type="button">Vendedor</button>
        <button class="tab" id="tabAdmin" type="button">Admin (local)</button>
      </div>
    </div>

    <!-- VENDEDOR -->
    <section id="pageCity" class="grid">
      <div class="card">
        <div class="hd">
          <div class="title">Registro de visita</div>
          <div class="badge" title="Estado de sincronización">
            <span class="dot" id="cloudDot" style="background:#f59e0b;box-shadow:0 0 0 4px rgba(245,158,11,.18)"></span>
            <span id="cloudStatus">Cloud: sin configurar</span>
          </div>
        </div>
        <div class="bd">
          <div class="row">
            <div class="field">
              <label>Ciudad</label>
              <select id="citySelect"></select>
            </div>
            <div class="field">
              <label>Vendedor</label>
              <select id="vendorSelect"></select>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="field">
              <label>Cliente a visitar</label>
              <input id="clientInput" placeholder="Ej. Sushi Factory / Casa Nipon / etc." />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="field">
              <label>Tipo de visita</label>
              <select id="typeSelect"></select>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="field">
              <label>Comentarios</label>
              <textarea id="notesInput" placeholder="Notas rápidas, faltantes, acuerdos, etc."></textarea>
            </div>
          </div>

          <div class="btnbar">
            <button class="btn primary" id="btnStart">Iniciar visita</button>
            <button class="btn" id="btnEnd" disabled>Terminar visita</button>
            <button class="btn" id="btnLocate">Ubicación</button>
          </div>

          <div class="hr"></div>

          <div class="kpis">
            <div class="kpi">
              <div class="lbl"><span>Visitas hoy</span><span class="mono" id="kpiDate"></span></div>
              <div class="val" id="kpiCount">0</div>
            </div>
            <div class="kpi">
              <div class="lbl"><span>Tiempo total</span><span class="muted">hrs</span></div>
              <div class="val" id="kpiHours">0.0</div>
            </div>
            <div class="kpi">
              <div class="lbl"><span>Clientes únicos</span><span class="muted">hoy</span></div>
              <div class="val" id="kpiClients">0</div>
            </div>
          </div>

          <div style="margin-top:12px" id="mapCity"></div>

          <div class="list" id="listCity"></div>

          <div class="footer">
            <span>Tip: si el GPS no pide permiso, abre el link en <b>HTTPS</b> (GitHub Pages ya lo es).</span>
            <span class="mono" id="buildStamp"></span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div class="title">Acciones rápidas</div>
          <div class="badge" title="Exporta para mandar a Dirección o para backup">
            <span style="width:8px;height:8px;border-radius:999px;background:#3b82f6;box-shadow:0 0 0 4px rgba(59,130,246,.18)"></span>
            Export
          </div>
        </div>
        <div class="bd">
          <div class="hint">
            Este modo guarda todo en <b>tu navegador</b>. Admin (local) solo puede ver lo que se registró en este mismo dispositivo.
            <br><br>
            Si quieres que Admin vea <b>todo de todos los celulares</b>, usa Supabase (nube). Esta versión ya soporta nube: solo pega <b>SUPABASE_URL</b> y <b>ANON_KEY</b> en el código.
          </div>

          <div class="hr"></div>

          <div class="btnbar">
            <button class="btn" id="btnExportJson">Exportar JSON (hoy)</button>
            <button class="btn" id="btnExportCsv">Exportar CSV (hoy)</button>
            <button class="btn danger" id="btnClearToday">Borrar hoy</button>
          </div>

          <div class="hr"></div>

          <div class="small muted">
            <div><b>Estado visita actual:</b> <span id="visitState">Sin visita activa</span></div>
            <div style="margin-top:6px"><b>Última ubicación:</b> <span class="mono" id="lastLoc">—</span></div>
          </div>

          <div class="hr"></div>

          <div class="hint">
            Si en tu Android/iPhone se “traba” el mapa:
            <ul>
              <li>Activa ubicación en el sistema</li>
              <li>Permite acceso al navegador</li>
              <li>Recarga con <span class="mono">?v=2</span> para evitar caché</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- ADMIN LOCAL -->
    <section id="pageAdmin" class="grid" style="display:none">
      <div class="card">
        <div class="hd">
          <div class="title">Admin (local)</div>
          <div class="badge" title="Fuente de datos">
            <span class="dot" id="adminDot" style="background:#3b82f6;box-shadow:0 0 0 4px rgba(59,130,246,.18)"></span>
            <span id="adminSourceLbl">Admin: Cloud</span>
          </div>
        </div>
        <div class="bd">
          <div class="row">
            <div class="field">
              <label>Fecha</label>
              <input id="adminDate" type="date" />
            </div>
            <div class="field">
              <label>Ciudad</label>
              <select id="adminCity">
                <option value="ALL">Todas</option>
              </select>
            </div>
            <div class="field">
              <label>Vendedor</label>
              <select id="adminVendor">
                <option value="ALL">Todos</option>
              </select>
            </div>

            <div class="field">
              <label>Fuente</label>
              <select id="adminSource">
                <option value="CLOUD">Cloud</option>
                <option value="LOCAL">Local</option>
              </select>
            </div>

          </div>

          <div class="btnbar">
            <button class="btn primary" id="btnAdminApply">Aplicar</button>
            <button class="btn" id="btnAdminTestCloud">Probar Cloud</button>
            <button class="btn" id="btnAdminExportJson">Exportar JSON</button>
          </div>

          <div class="hr"></div>

          <div class="kpis">
            <div class="kpi">
              <div class="lbl"><span>Registros</span><span class="muted">fecha</span></div>
              <div class="val" id="adminKpiCount">0</div>
            </div>
            <div class="kpi">
              <div class="lbl"><span>Horas</span><span class="muted">total</span></div>
              <div class="val" id="adminKpiHours">0.0</div>
            </div>
            <div class="kpi">
              <div class="lbl"><span>Clientes únicos</span><span class="muted">fecha</span></div>
              <div class="val" id="adminKpiClients">0</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="kpis">
            <div class="kpi">
              <div class="lbl"><span>GDL</span><span class="muted">registros</span></div>
              <div class="val" id="adminKpiGDL">0</div>
            </div>
            <div class="kpi">
              <div class="lbl"><span>MTY</span><span class="muted">registros</span></div>
              <div class="val" id="adminKpiMTY">0</div>
            </div>
            <div class="kpi">
              <div class="lbl"><span>CDMX</span><span class="muted">registros</span></div>
              <div class="val" id="adminKpiCDMX">0</div>
            </div>
          </div>

          <div style="margin-top:12px" id="mapAdmin"></div>

          <div class="list" id="listAdmin"></div>

          <div class="footer">
            <span class="hint">Admin local = solo ve lo que existe en este navegador.</span>
            <span class="mono">Ruta: puntos conectados en orden</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div class="title">Resumen por vendedor</div>
          <div class="badge">
            <span style="width:8px;height:8px;border-radius:999px;background:#a855f7;box-shadow:0 0 0 4px rgba(168,85,247,.18)"></span>
            Ranking
          </div>
        </div>
        <div class="bd">
          <div class="hint">Conteo de visitas por vendedor (según filtros).</div>
          <div class="hr"></div>
          <div class="list" id="adminVendorsSummary"></div>
        </div>
      </div>
    </section>
  </div>

<script>
(function(){
  // ====== Config ======

  // ====== Cloud (Supabase) ======
  // Pega tus datos aquí (Supabase > Project Settings > API)
  const SUPABASE_URL = "https://alprfxtjoyszkqvoeqkb.supabase.co";      // ej: https://xxxxx.supabase.co
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFscHJmeHRqb3lzemtxdm9lcWtiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NDg4MzUsImV4cCI6MjA4MzAyNDgzNX0.-nAPH5bv0e7oDvySgY9G5B83_afn34ByjmjnTlfiqqI"; // ej: eyJhbGciOi...

  const SUPABASE_TABLE = "visits";
  const PENDING_KEY = "app_visitas_pending_v1";

  function cloudConfigured(){
    return !!(SUPABASE_URL && SUPABASE_URL.startsWith("http") && SUPABASE_ANON_KEY && SUPABASE_ANON_KEY.length > 20);
  }
  function sbUrl(path){ return SUPABASE_URL.replace(/\/+$/,"") + path; }

  async function sbFetch(path, {method="GET", body=null, headers={}}={}){
    const h = {
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": "Bearer " + SUPABASE_ANON_KEY,
      ...headers
    };
    const opts = { method, headers: h };
    if(body!=null){
      opts.headers["Content-Type"] = "application/json";
      opts.body = JSON.stringify(body);
    }
    const res = await fetch(sbUrl(path), opts);
    const txt = await res.text().catch(()=> "");
    if(!res.ok){
      let msg = (txt || `HTTP ${res.status}`).trim();
      try{
        const j = JSON.parse(msg);
        msg = j.message || j.error_description || msg;
        if(j.code) msg += ` (code ${j.code})`;
        if(j.details) msg += ` · ${j.details}`;
      }catch(e){}
      throw new Error(msg);
    }
    if(!txt || !txt.trim()) return null; // return=minimal
    try{ return JSON.parse(txt); }catch(e){ return txt; }
  }

  function loadPending(){
    try{ return JSON.parse(localStorage.getItem(PENDING_KEY) || "[]"); }catch(e){ return []; }
  }
  function savePending(arr){
    localStorage.setItem(PENDING_KEY, JSON.stringify(arr || []));
  }

  async function cloudTest(){
    if(!cloudConfigured()) throw new Error("Cloud no configurado (SUPABASE_URL / ANON_KEY)");
    const path = `/rest/v1/${encodeURIComponent(SUPABASE_TABLE)}?select=id&limit=1`;
    await sbFetch(path);
    return true;
  }

  async function cloudInsertVisit(rec){
    const path = `/rest/v1/${encodeURIComponent(SUPABASE_TABLE)}`;
    await sbFetch(path, {
      method: "POST",
      headers: { "Prefer": "return=minimal" },
      body: rec
    });
  }

  async function cloudFlushPending(){
    if(!cloudConfigured()) return;
    const pending = loadPending();
    if(!pending.length) return;
    // intentamos subir en orden
    const still = [];
    for(const rec of pending){
      try{
        await cloudInsertVisit(rec);
      }catch(e){
        still.push(rec);
      }
    }
    savePending(still);
  }

  function setCloudIndicator(state, text){
    const dot = document.getElementById("cloudDot");
    const lbl = document.getElementById("cloudStatus");
    if(!dot || !lbl) return;
    lbl.textContent = text;
    if(state==="ok"){
      dot.style.background="#22c55e";
      dot.style.boxShadow="0 0 0 4px rgba(34,197,94,.18)";
    }else if(state==="warn"){
      dot.style.background="#f59e0b";
      dot.style.boxShadow="0 0 0 4px rgba(245,158,11,.18)";
    }else{
      dot.style.background="#ef4444";
      dot.style.boxShadow="0 0 0 4px rgba(239,68,68,.18)";
    }
  }

  const SELLERS = {
    CDMX: [
      "David Adrian Hernández Guzmán",
      "Javier Espinosa Olivares",
      "Ricardo Gutierrez Bandera",
      "Abraham Rene Valdes Gonzales",
      "Jesus Antonio Ramirez Rivera",
      "Sergio Servin Rivera",
      "Eduardo Faustino Hernandez Sanchez",
      "Andres Fierro Ibañez",
      "Tohru Kurasawa",
      "Tanno Nobuko"
    ],
    MTY: [
      "Jessica Palomo",
      "Luis Heredia",
      "Carla Hernánde"
    ],
    GDL: [
      "Aguilar Neri Daniel",
      "De la Cruz Ponce Julio Cesar",
      "Garibay Ortiz Sergio Joel",
      "Sierra de Anda Aldo",
      "Perez Mar Alan Roberto",
      "Reynoso Aguilar Maricela",
      "Sandra Navarro Navarro",
      "Aguirre Ojeda Arcenio",
      "Velez Castellanos Antonio",
      "Yepez Mora Oscar Alberto",
      "Sanchez Esmeralda",
      "Reynaga Valeria",
      "González Guzmán Cristian Eduardo"
    ]
  };

  const CITY_META = [
    {code:"GDL", label:"Guadalajara"},
    {code:"MTY", label:"Monterrey"},
    {code:"CDMX", label:"México"}
  ];

  const VISIT_TYPES = [
    "Degustación",
    "Entrega de faltantes",
    "Entrega de nuevo productos",
    "Visita Potencialidad",
    "Visita de Seguimiento",
    "Cobranza"
  ];

  // ====== DOM ======
  const $ = (q)=>document.querySelector(q);
  const citySelect = $("#citySelect");
  const vendorSelect = $("#vendorSelect");
  const clientInput = $("#clientInput");
  const typeSelect = $("#typeSelect");
  const notesInput = $("#notesInput");
  const btnStart = $("#btnStart");
  const btnEnd = $("#btnEnd");
  const btnLocate = $("#btnLocate");
  const listCity = $("#listCity");
  const kpiDate = $("#kpiDate");
  const kpiCount = $("#kpiCount");
  const kpiHours = $("#kpiHours");
  const kpiClients = $("#kpiClients");
  const buildStamp = $("#buildStamp");
  const visitState = $("#visitState");
  const lastLoc = $("#lastLoc");

  const tabCity = $("#tabCity");
  const tabAdmin = $("#tabAdmin");
  const pageCity = $("#pageCity");
  const pageAdmin = $("#pageAdmin");

  const adminDate = $("#adminDate");
  const adminCity = $("#adminCity");
  const adminVendor = $("#adminVendor");
  const adminSource = $("#adminSource");
  const btnAdminTestCloud = $("#btnAdminTestCloud");
  const adminSourceLbl = $("#adminSourceLbl");
  const adminDot = $("#adminDot");
  const btnAdminApply = $("#btnAdminApply");
  const btnAdminExportJson = $("#btnAdminExportJson");
  const adminKpiCount = $("#adminKpiCount");
  const adminKpiHours = $("#adminKpiHours");
  const adminKpiClients = $("#adminKpiClients");
  const adminKpiGDL = $("#adminKpiGDL");
  const adminKpiMTY = $("#adminKpiMTY");
  const adminKpiCDMX = $("#adminKpiCDMX");
  const listAdmin = $("#listAdmin");
  const adminVendorsSummary = $("#adminVendorsSummary");

  // Export buttons
  const btnExportJson = $("#btnExportJson");
  const btnExportCsv = $("#btnExportCsv");
  const btnClearToday = $("#btnClearToday");

  // ====== Storage ======
  const LS_KEY = "app_visitas_local_v1";
  const SS_ACTIVE = "app_visitas_active_v1";

  function todayISO(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function uuid(){
    // simple uuid (good enough for local)
    return (crypto?.randomUUID?.() || ("id-" + Date.now() + "-" + Math.random().toString(16).slice(2)));
  }

  function loadAll(){
    try{return JSON.parse(localStorage.getItem(LS_KEY) || "{}");}catch(e){return {};}
  }
  function saveAll(data){
    localStorage.setItem(LS_KEY, JSON.stringify(data));
  }

  function loadDay(day){
    const all = loadAll();
    return Array.isArray(all[day]) ? all[day] : [];
  }
  function saveDay(day, arr){
    const all = loadAll();
    all[day] = arr;
    saveAll(all);
  }

  function activeGet(){
    try{return JSON.parse(sessionStorage.getItem(SS_ACTIVE) || "null");}catch(e){return null;}
  }
  function activeSet(obj){
    sessionStorage.setItem(SS_ACTIVE, JSON.stringify(obj));
  }
  function activeClear(){
    sessionStorage.removeItem(SS_ACTIVE);
  }

  // ====== UI Helpers ======
  function cityLabel(code){
    const m = CITY_META.find(x=>x.code===code);
    return m ? m.label : code;
  }
  function fmtTime(ts){
    if(!ts) return "—";
    const d = new Date(ts);
    return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
  }
  function secToH(sec){
    return (sec/3600).toFixed(1);
  }
  function toast(msg){
    // minimal toast using alert-like, but non-blocking
    const el = document.createElement("div");
    el.textContent = msg;
    el.style.position="fixed";
    el.style.left="50%";
    el.style.bottom="18px";
    el.style.transform="translateX(-50%)";
    el.style.padding="12px 14px";
    el.style.borderRadius="999px";
    el.style.background="rgba(15,23,42,.92)";
    el.style.color="#fff";
    el.style.fontWeight="900";
    el.style.fontSize="12px";
    el.style.boxShadow="0 16px 40px rgba(0,0,0,.22)";
    el.style.zIndex="999999";
    document.body.appendChild(el);
    setTimeout(()=>{ el.style.opacity="0"; el.style.transition="opacity .35s"; }, 1800);
    setTimeout(()=>{ el.remove(); }, 2300);
  }

  // ====== Map ======
  let mapCity, mapAdmin;
  let layerCity, layerAdmin;
  function ensureCityMap(){
    if(mapCity) return;
    mapCity = L.map("mapCity", { zoomControl:true });
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom:19, attribution:'&copy; OpenStreetMap'
    }).addTo(mapCity);
    layerCity = L.layerGroup().addTo(mapCity);
    mapCity.setView([20.6736, -103.344], 11); // GDL default
  }
  function ensureAdminMap(){
    if(mapAdmin) return;
    mapAdmin = L.map("mapAdmin", { zoomControl:true });
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom:19, attribution:'&copy; OpenStreetMap'
    }).addTo(mapAdmin);
    layerAdmin = L.layerGroup().addTo(mapAdmin);
    mapAdmin.setView([23.6345, -102.5528], 5); // MX
  }

  function clearLayer(layer){ if(layer) layer.clearLayers(); }

  function plotRoute(layer, recs){
    clearLayer(layer);
    const pts = [];
    recs.forEach(r=>{
      const lat = r.end_lat ?? r.start_lat;
      const lng = r.end_lng ?? r.start_lng;
      if(typeof lat==="number" && typeof lng==="number"){
        pts.push([lat,lng]);
        const label = `<b>${r.client || "—"}</b><br>${cityLabel(r.city)} · ${r.vendor || "—"}<br>${r.type || "—"}<br><span style="color:#64748b">${fmtTime(r.start_ts)} - ${fmtTime(r.end_ts)}</span>`;
        L.marker([lat,lng]).bindPopup(label).addTo(layer);
      }
    });
    if(pts.length>=2){
      L.polyline(pts).addTo(layer);
    }
    return pts;
  }

  function fitToPoints(map, pts){
    if(!map || !pts || pts.length===0) return;
    if(pts.length===1){
      map.setView(pts[0], 15);
      return;
    }
    const b = L.latLngBounds(pts);
    map.fitBounds(b.pad(0.2));
  }

  // ====== Geolocation ======
  function getPos(){
    return new Promise((resolve, reject)=>{
      if(!navigator.geolocation) return reject(new Error("Tu dispositivo no soporta GPS."));
      navigator.geolocation.getCurrentPosition(
        (pos)=>resolve(pos),
        (err)=>reject(err),
        { enableHighAccuracy:true, timeout:15000, maximumAge:10000 }
      );
    });
  }
  function setLastLoc(pos){
    const lat = pos?.coords?.latitude;
    const lng = pos?.coords?.longitude;
    if(typeof lat==="number" && typeof lng==="number"){
      lastLoc.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    }
  }

  // ====== Render (City) ======
  function renderCity(){
    const day = todayISO();
    kpiDate.textContent = day;
    const recs = loadDay(day);

    // KPIs
    const total = recs.length;
    const totalSec = recs.reduce((a,r)=> a + (r.duration_sec || 0), 0);
    const clients = new Set(recs.map(r=>(r.client||"").trim()).filter(Boolean)).size;

    kpiCount.textContent = total;
    kpiHours.textContent = secToH(totalSec);
    kpiClients.textContent = clients;

    // List
    listCity.innerHTML = "";
    if(total===0){
      listCity.innerHTML = `<div class="item"><div class="meta">Aún no hay visitas registradas hoy.</div></div>`;
    }else{
      recs.slice().sort((a,b)=> (a.start_ts||0) - (b.start_ts||0)).forEach(r=>{
        const el = document.createElement("div");
        el.className="item";
        const dur = r.duration_sec ? Math.round(r.duration_sec/60) + " min" : "—";
        el.innerHTML = `
          <div class="top">
            <div>
              <div class="name">${escapeHtml(r.client||"—")}</div>
              <div class="meta">${cityLabel(r.city)} · ${escapeHtml(r.vendor||"—")} · ${fmtTime(r.start_ts)} - ${fmtTime(r.end_ts)} · ${dur}</div>
            </div>
            <span class="chip">${escapeHtml(r.type||"—")}</span>
          </div>
          ${r.notes ? `<div class="meta" style="margin-top:8px">${escapeHtml(r.notes)}</div>` : ""}
        `;
        listCity.appendChild(el);
      });
    }

    // Map
    ensureCityMap();
    const pts = plotRoute(layerCity, recs.slice().sort((a,b)=> (a.start_ts||0)-(b.start_ts||0)));
    fitToPoints(mapCity, pts);

    // Active visit status
    const act = activeGet();
    if(act && act.start_ts){
      visitState.textContent = `En visita desde ${fmtTime(act.start_ts)} · ${cityLabel(act.city)} · ${act.vendor||"—"}`;
      btnStart.disabled = true;
      btnEnd.disabled = false;
    }else{
      visitState.textContent = "Sin visita activa";
      btnStart.disabled = false;
      btnEnd.disabled = true;
    }
  }

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ====== Render (Admin local) ======
  function refreshAdminCityOptions(){
    // already has ALL
    const seen = new Set([...adminCity.options].map(o=>o.value));
    CITY_META.forEach(c=>{
      if(!seen.has(c.code)){
        const opt = document.createElement("option");
        opt.value = c.code;
        opt.textContent = c.label;
        adminCity.appendChild(opt);
      }
    });
  }

  function refreshAdminVendorOptions(){
    const city = adminCity.value || "ALL";
    const prev = adminVendor.value || "ALL";
    adminVendor.innerHTML = `<option value="ALL">Todos</option>`;
    let vendors = [];
    if(city==="ALL"){
      vendors = [...new Set(Object.values(SELLERS).flat())].sort();
    }else{
      vendors = (SELLERS[city] || []).slice().sort();
    }
    vendors.forEach(v=>{
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      adminVendor.appendChild(opt);
    });
    // restore
    [...adminVendor.options].some(o=>o.value===prev) && (adminVendor.value=prev);
  }

  
  async function applyAdmin(){
    const day = adminDate.value || todayISO();
    const city = adminCity.value || "ALL";
    const vendor = adminVendor.value || "ALL";
    const source = (adminSource?.value || "CLOUD");

    let base = [];

    if(source === "CLOUD" && cloudConfigured()){
      try{
        // Traemos el día completo y filtramos localmente (más robusto)
        const cols = [
          "id","day","city","vendor","client","type","notes",
          "start_ts","end_ts","duration_sec",
          "start_lat","start_lng","end_lat","end_lng",
          "created_at"
        ].join(",");
        const qs = [
          `select=${cols}`,
          `day=eq.${day}`,
          "order=start_ts.asc.nullslast",
          "limit=5000"
        ].join("&");
        const path = `/rest/v1/${encodeURIComponent(SUPABASE_TABLE)}?` + qs;
        const rows = await sbFetch(path);
        base = Array.isArray(rows) ? rows : [];
      }catch(e){
        toast("Admin Cloud falló, mostrando Local");
        base = loadDay(day);
      }
    }else{
      base = loadDay(day);
    }

    // Normaliza ciudad si viene diferente
    base = base.map(r=>{
      const c = (r.city || "").toString().trim().toUpperCase();
      let cc = c;
      if(cc.includes("GUADALAJARA")) cc="GDL";
      if(cc.includes("MONTERREY")) cc="MTY";
      if(cc.includes("MEXICO") || cc.includes("MÉXICO")) cc="CDMX";
      return {...r, city: cc};
    });

    let recs = base.slice();

    // Filters
    if(city !== "ALL") recs = recs.filter(r=>r.city===city);
    if(vendor !== "ALL") recs = recs.filter(r=>(r.vendor||"")===vendor);

    // KPIs
    const total = recs.length;
    const totalSec = recs.reduce((a,r)=>a+(r.duration_sec||0),0);
    const clients = new Set(recs.map(r=>(r.client||"").trim()).filter(Boolean)).size;

    adminKpiCount.textContent = total;
    adminKpiHours.textContent = secToH(totalSec);
    adminKpiClients.textContent = clients;

    // City breakdown (desde base del día)
    const byCity = {GDL:0, MTY:0, CDMX:0};
    base.forEach(r=>{ if(byCity[r.city]!==undefined) byCity[r.city]++; });
    adminKpiGDL.textContent = byCity.GDL;
    adminKpiMTY.textContent = byCity.MTY;
    adminKpiCDMX.textContent = byCity.CDMX;

    // List
    listAdmin.innerHTML = "";
    if(total===0){
      listAdmin.innerHTML = `<div class="item"><div class="meta">No hay registros con esos filtros.</div></div>`;
    }else{
      recs.slice().sort((a,b)=> (a.start_ts||0)-(b.start_ts||0)).forEach(r=>{
        const el = document.createElement("div");
        el.className="item";
        const dur = r.duration_sec ? Math.round(r.duration_sec/60) + " min" : "—";
        el.innerHTML = `
          <div class="top">
            <div>
              <div class="name">${escapeHtml(r.client||"—")}</div>
              <div class="meta">${cityLabel(r.city)} · ${escapeHtml(r.vendor||"—")} · ${fmtTime(r.start_ts)} - ${fmtTime(r.end_ts)} · ${dur}</div>
            </div>
            <span class="chip">${escapeHtml(r.type||"—")}</span>
          </div>
          ${r.notes ? `<div class="meta" style="margin-top:8px">${escapeHtml(r.notes)}</div>` : ""}
        `;
        listAdmin.appendChild(el);
      });
    }

    // Map
    ensureAdminMap();
    const pts = plotRoute(layerAdmin, recs.slice().sort((a,b)=> (a.start_ts||0)-(b.start_ts||0)));
    fitToPoints(mapAdmin, pts);

    // Summary by vendor
    const counts = {};
    recs.forEach(r=>{
      const v = (r.vendor||"—");
      counts[v] = (counts[v]||0) + 1;
    });
    const items = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
    adminVendorsSummary.innerHTML = "";
    if(items.length===0){
      adminVendorsSummary.innerHTML = `<div class="item"><div class="meta">Sin datos.</div></div>`;
    }else{
      items.forEach(([v,c])=>{
        const el = document.createElement("div");
        el.className="item";
        el.innerHTML = `<div class="top"><div><div class="name">${escapeHtml(v)}</div><div class="meta">${c} visita(s)</div></div><span class="chip">${c}</span></div>`;
        adminVendorsSummary.appendChild(el);
      });
    }

    // Badge
    if(adminSourceLbl && adminDot){
      if(source==="CLOUD" && cloudConfigured()){
        adminSourceLbl.textContent = "Admin: Cloud";
        adminDot.style.background="#22c55e";
        adminDot.style.boxShadow="0 0 0 4px rgba(34,197,94,.18)";
      }else{
        adminSourceLbl.textContent = "Admin: Local";
        adminDot.style.background="#3b82f6";
        adminDot.style.boxShadow="0 0 0 4px rgba(59,130,246,.18)";
      }
    }
  }


  // ====== Actions ======
  async function locate(){
    try{
      const pos = await getPos();
      setLastLoc(pos);
      toast("Ubicación capturada");
      // move map to current
      ensureCityMap();
      const lat = pos.coords.latitude, lng = pos.coords.longitude;
      mapCity.setView([lat,lng], 16);
    }catch(e){
      toast("No se pudo obtener ubicación");
    }
  }

  async function startVisit(){
    const city = citySelect.value;
    const vendor = vendorSelect.value;
    const client = (clientInput.value || "").trim();
    const type = typeSelect.value;
    const notes = (notesInput.value || "").trim();

    if(!city || !vendor){
      toast("Selecciona ciudad y vendedor");
      return;
    }
    if(!client){
      toast("Escribe el cliente");
      clientInput.focus();
      return;
    }

    const act = activeGet();
    if(act && act.start_ts){
      toast("Ya hay una visita activa");
      return;
    }

    btnStart.disabled = true;

    try{
      const pos = await getPos();
      setLastLoc(pos);
      const now = new Date().toISOString();
      activeSet({
        city, vendor, client, type, notes,
        start_ts: now,
        start_lat: pos.coords.latitude,
        start_lng: pos.coords.longitude
      });
      toast("Visita iniciada");
      renderCity();
    }catch(e){
      toast("Activa permisos de ubicación");
      btnStart.disabled = false;
    }
  }

  async function endVisit(){
    const act = activeGet();
    if(!act || !act.start_ts){
      toast("No hay visita activa");
      return;
    }
    btnEnd.disabled = true;

    try{
      const pos = await getPos();
      setLastLoc(pos);
      const end = new Date();
      const endISO = end.toISOString();
      const start = new Date(act.start_ts);
      const durSec = Math.max(0, Math.floor((end.getTime()-start.getTime())/1000));

      const rec = {
        id: uuid(),
        day: todayISO(),
        city: act.city,
        vendor: act.vendor,
        client: act.client,
        type: act.type,
        notes: act.notes,

        start_ts: act.start_ts,
        end_ts: endISO,
        duration_sec: durSec,

        start_lat: act.start_lat,
        start_lng: act.start_lng,
        end_lat: pos.coords.latitude,
        end_lng: pos.coords.longitude
      };

      const day = todayISO();
      const recs = loadDay(day);
      recs.push(rec);
      saveDay(day, recs);

      // Cloud sync (si está configurado)
      if(cloudConfigured()){
        try{
          await cloudInsertVisit(rec);
          toast("Cloud: subido OK");
          await cloudFlushPending();
          setCloudIndicator("ok", "Cloud: online");
        }catch(e){
          const pend = loadPending();
          pend.push(rec);
          savePending(pend);
          toast("Cloud: fallo, quedó pendiente");
          setCloudIndicator("warn", "Cloud: pendiente");
        }
      }else{
        setCloudIndicator("warn", "Cloud: sin configurar");
      }

      activeClear();
      toast("Visita guardada");
      renderCity();
    }catch(e){
      toast("No se pudo cerrar (GPS)");
      btnEnd.disabled = false;
    }
  }

  function exportJson(day){
    const recs = loadDay(day);
    const blob = new Blob([JSON.stringify(recs, null, 2)], {type:"application/json"});
    downloadBlob(blob, `visitas_${day}.json`);
  }

  function exportCsv(day){
    const recs = loadDay(day);
    const headers = [
      "id","day","city","vendor","client","type","notes",
      "start_ts","end_ts","duration_sec",
      "start_lat","start_lng","end_lat","end_lng"
    ];
    const lines = [headers.join(",")];
    recs.forEach(r=>{
      const row = headers.map(k=>{
        const v = (r[k] ?? "");
        const s = (typeof v === "string") ? v.replaceAll('"','""') : String(v);
        return `"${s}"`;
      }).join(",");
      lines.push(row);
    });
    const blob = new Blob([lines.join("\n")], {type:"text/csv"});
    downloadBlob(blob, `visitas_${day}.csv`);
  }

  function downloadBlob(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 800);
  }

  function clearToday(){
    const day = todayISO();
    saveDay(day, []);
    activeClear();
    toast("Borrado");
    renderCity();
  }

  // ====== Init ======
  function fillCity(){
    CITY_META.forEach(c=>{
      const opt = document.createElement("option");
      opt.value = c.code;
      opt.textContent = c.label;
      citySelect.appendChild(opt);
    });
  }
  function fillVendors(city){
    vendorSelect.innerHTML = "";
    (SELLERS[city] || []).forEach(v=>{
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      vendorSelect.appendChild(opt);
    });
  }
  function fillTypes(){
    VISIT_TYPES.forEach(t=>{
      const opt = document.createElement("option");
      opt.value = t;
      opt.textContent = t;
      typeSelect.appendChild(opt);
    });
  }

  function switchTab(which){
    const isCity = which==="city";
    tabCity.classList.toggle("active", isCity);
    tabAdmin.classList.toggle("active", !isCity);
    pageCity.style.display = isCity ? "" : "none";
    pageAdmin.style.display = isCity ? "none" : "";
    if(!isCity){
      ensureAdminMap();
      setTimeout(()=>mapAdmin.invalidateSize(), 80);
      applyAdmin();
    }else{
      ensureCityMap();
      setTimeout(()=>mapCity.invalidateSize(), 80);
    }
  }

  function loadPrefs(){
    try{
      const p = JSON.parse(localStorage.getItem("app_visitas_prefs_v1") || "{}");
      if(p.city && CITY_META.some(x=>x.code===p.city)) citySelect.value = p.city;
      fillVendors(citySelect.value);
      if(p.vendor){
        [...vendorSelect.options].some(o=>o.value===p.vendor) && (vendorSelect.value=p.vendor);
      }
    }catch(e){
      fillVendors(citySelect.value);
    }
  }

  function savePrefs(){
    const p = { city: citySelect.value, vendor: vendorSelect.value };
    localStorage.setItem("app_visitas_prefs_v1", JSON.stringify(p));
  }

  function init(){
    buildStamp.textContent = "BUILD " + new Date().toISOString().slice(0,19).replace("T"," ");

    // Cloud status
    if(cloudConfigured()){
      setCloudIndicator("warn", "Cloud: verificando...");
      cloudTest().then(()=>{
        setCloudIndicator("ok", "Cloud: online");
        cloudFlushPending();
      }).catch(()=>{
        setCloudIndicator("bad", "Cloud: error");
      });
    }else{
      setCloudIndicator("warn", "Cloud: sin configurar");
    }
    fillCity();
    citySelect.value = "GDL";
    fillTypes();
    loadPrefs();
    renderCity();

    refreshAdminCityOptions();
    refreshAdminVendorOptions();
    adminDate.value = todayISO();
    if(adminSource){ adminSource.value = cloudConfigured() ? "CLOUD" : "LOCAL"; }

    // Events
    citySelect.addEventListener("change", ()=>{
      fillVendors(citySelect.value);
      savePrefs();
      renderCity();
    });
    vendorSelect.addEventListener("change", savePrefs);

    btnLocate.addEventListener("click", locate);
    btnStart.addEventListener("click", startVisit);
    btnEnd.addEventListener("click", endVisit);

    btnExportJson.addEventListener("click", ()=>exportJson(todayISO()));
    btnExportCsv.addEventListener("click", ()=>exportCsv(todayISO()));
    btnClearToday.addEventListener("click", clearToday);

    tabCity.addEventListener("click", ()=>switchTab("city"));
    tabAdmin.addEventListener("click", ()=>switchTab("admin"));

    adminCity.addEventListener("change", ()=>{
      refreshAdminVendorOptions();
    });
    if(adminSource){
      adminSource.addEventListener("change", ()=>applyAdmin());
    }
    btnAdminApply.addEventListener("click", ()=>applyAdmin());
    if(btnAdminTestCloud){
      btnAdminTestCloud.addEventListener("click", async ()=>{
        try{
          setCloudIndicator("warn", "Cloud: verificando...");
          await cloudTest();
          setCloudIndicator("ok", "Cloud: online");
          toast("Cloud OK");
          await cloudFlushPending();
        }catch(e){
          setCloudIndicator("bad", "Cloud: error");
          toast("Cloud error");
        }
      });
    }

    btnAdminExportJson.addEventListener("click", ()=>{
      const day = adminDate.value || todayISO();
      const data = loadDay(day);
      const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
      downloadBlob(blob, `admin_visitas_${day}.json`);
    });

    // Restore active state buttons
    const act = activeGet();
    if(act && act.start_ts){
      btnStart.disabled = true;
      btnEnd.disabled = false;
    }

    // Map resize fix on load
    ensureCityMap();
    setTimeout(()=>mapCity.invalidateSize(), 120);
  }

  init();
})();
</script>
</body>
</html>
